upstream database {
  postgres_server  127.0.0.1 dbname=retriever_development
                   user=nginx_user password=nginx_password;
}

server {
  listen 27027;
  server_name localhost;
  access_log logs/localhost.access.log combined;

  location = /report {
    add_header Content-Type text/plain;
    postgres_pass database;
    read_request_body;
    if ($request_method != POST) {
      return 405;
    }

    postgres_escape $remote_addr_escaped $remote_addr;
    postgres_escape $request_escaped $request_body;

    add_header X-Debug $request_escaped;
    postgres_query POST "INSERT INTO reports (remote_addr, data, created_at, updated_at) VALUES ($remote_addr_escaped, $request_escaped, now(), now())";
    postgres_output none;
  }

  location = /dump {
    allow 127.0.0.0/8;
    deny all;
    add_header Content-Type text/plain;
    postgres_pass database;
    postgres_output text;
    postgres_query "SELECT * FROM reports";
  }

  location = / {
    add_header Content-Type text/plain;
    return 200;
  }

  location = /test {
    allow 127.0.0.0/8;
    deny all;
    add_header Content-Type text/plain;
    read_request_body;
    set $resp "$request_body ____ stuff";
    return 200 $resp;
  }

  location = /csp_test {
    add_header Content-Security-Policy "style-src http://localhost; report-uri http://localhost:27027/report";
    add_header Content-Type text/html;
    return 200 "<html><head><link rel='stylesheet' type='text/css' href='https://www.abv.bg/css/styles_20180329.css'></head></html>";
  }
}
